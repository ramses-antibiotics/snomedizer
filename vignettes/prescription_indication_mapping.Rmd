---
title: "Mapping SNOMED CT concepts from free text"
date: '`r format(Sys.Date(), "%d %B %Y")`'
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
    fig_caption: yes 
vignette: >
  %\VignetteIndexEntry{Mapping SNOMED CT concepts from free text}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(snomedizer)
data("drug_indications")
```


# Introduction

Analysing electronic health records often requires processing free-text data generated by clinicians' interactions with a variety of clinical systems. Manually classifying and coding free-text data on a large scale is impractical. 

In those cases, SNOMED CT can help in several ways:

1. identifying clinical concepts within the free text, using SNOMED CT's list of known synonyms (or 'descriptions') for a given concept. For instance, `78048006` is has multiple descriptions: `Candidiasis` (preferred term); `Candidosis`; `Candida infection`; `Moniliasis`; `Monilia infection`; and `Thrush`
2. reclassifying clinical concepts into broader ('parent') concepts (eg `40600002 | Pneumococcal bronchitis (disorder) |` is a `275498002 | Respiratory tract infection (disorder) |`)
3. extracting stated/inferred attributes from the SNOMED CT ontology (eg the pathogen causing `40600002 | Pneumococcal bronchitis (disorder) |` is `9861002 | Streptococcus pneumoniae (organism) |`)

A handy introduction to the SNOMED CT terminology can be found in the <a href="http://snomed.org/sg" target="_blank">SNOMED CT Starter Guide</a>, particularly chapters [5. SNOMED CT Logical Model](http://snomed.org/sg/5.+SNOMED+CT+Logical+Model) and [6. SNOMED CT Concept Model](http://snomed.org/sg/6.+SNOMED+CT+Concept+Model).

This vignette demonstrates a simple workflow to extract SNOMED CT concepts from free-text information and use the full SNOMED CT ontology to reclassify these concepts into higher-level ones.

# Motivating example

Hospitals commonly need to carry out clinical audits of antibiotic prescribing. This involves measuring what antibiotics are prescribed for, and whether the dose/duration of prescriptions is suitable. Many clinical systems record prescription indications as free-text data.

For this, the prescription indication must be extracted and grouped into categories. We examine an example dataset named `drug_indications` from a hospital electronic prescription system, containing free-text indications for `r nrow(drug_indications)` prescriptions.

```{r glimpse_indications}
library(snomedizer)
str(drug_indications)
```
In this example, we aim to identify the proportion of prescribing by type of infection.

# Preparation

## Environment setup

We rely on several packages from the [`tidyverse`](https://www.tidyverse.org/learn/) to help manipulate structured data as well as string data (free-text).

```{r load_packages, message=FALSE, warning=FALSE}
library(dplyr)       # relational data wrangling package 
library(tidyr)       # tidy data
library(stringr)     # to manipulate strings (free-text data) 
# library(tidytext)    # to manipulate strings (free-text data)
library(stopwords)   # lists common and uncharacteristics words to discard
library(data.table)  # faster processing
library(text2vec)    # natural langage processing
```

We connect to the July 2021 release branch on the official IHTSDO Snowstorm server.

```{r setup_snowstorm_server, eval = FALSE}
# Public SNOMED CT terminology server and branch
sct_server <- "https://snowstorm.ihtsdotools.org/snowstorm/snomed-ct"
sct_branch <- "MAIN/2021-07-31"

# Verify that the server connection is working
snomed_endpoint_test(sct_server, sct_branch)
#> [1] TRUE

snomedizer_options_set(endpoint = sct_server, 
                       branch = sct_branch, 
                       limit = 10000)
```

<div class="bd-callout bd-callout-warning">
<h4>SNOMED CT Licence</h4>
<p>This vignette uses SNOMED CT data under the <emph>SNOMED CT Browser License Agreement</emph>.</p>
<p>Terms and conditions can be found on <code>help("snomedizer")</code>.</p>
</div>


## Fetching concepts and descriptions

The first step is to fetch all SNOMED CT concepts that are relevant to the analysis. This vignette about antibiotic prescriptions is primarily interested in infectious diseases. The concepts of interest descend from the following SNOMED CT concepts, either through stated or inferred relationships:

- `40733004 | Infectious disease (disorder) |`  
- `473130003 | Suspected infectious disease (situation) |`, for syndromes that have yet to be diagnosed
- additional syndromes that are believed to be infections, but not explicitly recorded as such. For example, doctors will commonly use the concept <code>233604007 | Pneumonia (disorder) |</code> in notes and prescribe an antibacterial. In this instance we can infer they imply <code>312342009 | Infective pneumonia (disorder) |</code> or even <code>53084003 | Bacterial pneumonia (disorder) |</code>, which unlike <code>233604007</code> are descendants of  <code>40733004 | Infectious disease (disorder) | </code>


<div class="bd-callout bd-callout-info">

<h4>Note</h4>

<p>Antibiotics can also be prescribed for:</p>
<ul>
<li><strong>medical prophylaxis</strong>, to prevent a urinary tract infection. This procedure can be described with a more complex <i>postcoordinated</i> SNOMED CT expression:

<pre><code>281789004 |Antibiotic therapy (procedure)|:
{ 363703001 |Has intent (attribute)| = 360271000 |Prophylaxis - procedure intent (qualifier value)|,
  363702006 |Has focus (attribute)|  = 68566005 |Urinary tract infectious disease (disorder)| }</code></pre>
  
</li>
<li><strong>surgical prophylaxis</strong>, to prevent a surgical site infection that could occur as part of a <code>362958002 | Procedure by site (procedure) |</code>, for instance:

<pre><code>281789004 |Antibiotic therapy (procedure)|: 
{ 363703001 |Has intent (attribute)| = 360271000 |Prophylaxis - procedure intent (qualifier value)|,  
  363702006 |Has focus (attribute)|  = 179750003 | Incision of soft tissue of hand (procedure) | }</code></pre>

</li>
</ul>

<p>This contrasts with infection treatment, where 
<pre><code>363703001 |Has intent (attribute)| = 373808002 | Curative - procedure intent (qualifier value) |</code></pre>
</p>
<p>For simplicity, we ignore prophylactic use or SNOMED CT expressions in this vignette.</p>
<p>You can learn more about postcoordinated SNOMED CT expressions in the <a href="https://confluence.ihtsdotools.org/display/DOCSTART/7.+SNOMED+CT+Expressions">SNOMED CT Starter Guide (chapter 7)</a>.</p>

</div>


We query the terminology server in two steps: (1) we retrieve and combine descendants of the three concepts cited above using <code>dplyr::bind_rows()</code>, then (2) retrieve descriptions of each of these concepts:

```{r fetch_infection_concepts_DONTRUN, eval=FALSE, include=TRUE}
# (1) Fetch all concepts descending from 40733004, 128045006, or 128477000
snomed_concepts <- concepts_descendants(
  conceptIds = c("40733004 | Infectious disease (disorder) |",
                 "128045006 | Cellulitis (disorder) |",
                 "128477000 | Abscess (disorder) |")
) %>%
  bind_rows() %>%
  unique()

# (2) Fetch all descriptions for these concepts
snomed_descriptions <- snomed_concepts %>% 
  concepts_descriptions(conceptIds = .$conceptId) %>% 
  bind_rows() # collapse into single data frame
```

```{r fetch_infection_concepts_RUN, include=FALSE}
snomed_descriptions <- snomedizer:::abx_indications_descriptions
snomed_concepts <- snomedizer:::abx_indications_concepts
```


`snomed_concepts` contains `r formatC(nrow(snomed_concepts), big.mark = ",")` concepts, with a total `r formatC(nrow(snomed_descriptions), big.mark = ",")` descriptions. Each concept has a minimum of 2 description records per concept: 1 fully specified name (FSN), and at least 1 (preferred) synonym. Some concepts will have more synonyms.

```{r glimpse_concepts}
snomed_concepts %>% 
  select(conceptId, active, pt.term, total) %>% 
  glimpse()

snomed_descriptions %>% 
  select(conceptId, descriptionId, term, active, type, 
         acceptabilityMap.900000000000509007, total) %>% 
  glimpse()
```


# Named entity recognition

To identify SNOMED CT concepts in the free text indications, we need to:

1. simplify and tokenise the SNOMED CT descriptions
2. clean typos, replace acronyms, and tokenise in the free text drug indication data
3. compare the drug indication data with every SNOMED CT description

Tokenisation involves separating individual words (or 'tokens') making up a character string into a vector.

## Processing SNOMED CT description strings

To make use of concept descriptions, we need to isolate and stardardise words making up the terminology. Only active synonyms are used (FSNs being redundant). After trimming punctuation, synonym descriptions are converted to lowercase.

```{r clean_snomed_descriptions}
snomed_descriptions_tokens <- snomed_descriptions %>% 
  filter(active & type != "FSN") %>%
  select(conceptId, descriptionId, term) %>%
  mutate(text_processed = tolower(term))
  # group_by(conceptId) %>%
  # tidyr::nest() %>%
  # transmute(conceptId, descriptions = data)

snomed_cleaning_patterns <- matrix(c(
    "[(]disorder[)]",                                     "",
    "[(]disease[)]",                                      "",
    "septicaemia",                                        "sepsis",
    "septicemia",                                         "sepsis",
    "post procedure",                                     "post_procedure",
    "community[-\\s]acquired",                            "community_acquired",
    "hospital[-\\s]acquired",                             "hospital_acquired",
    "institution(ally)?[-\\s]acquired",                   "institution_acquired",
    "guinea-worm",                                        "guinea worm",
    "(initial|extensive|active)([[:blank:]])(stage)",     "\\1_\\3",
    "\\bstage ([0-5])",                                   "stage_\\1",
    "candidal",                                           "candida", #"F_CANDD",
    "intra-abdominal|intraabdominal",                     "abdominal",
    "(\\w)'s\\b",                                         "\\1",
    "gram[-\\s]negative",                                 "gram_negative",
    "gram[-\\s]positive",                                 "gram_postivie",
    "[(),.]",                                             "",
    "-",                                                  " "
), ncol=2, byrow = TRUE)
colnames(snomed_cleaning_patterns) <- c(
  "pattern",
  "replacement"
)

for(i in seq_len(nrow(snomed_cleaning_patterns))) {
  snomed_descriptions_tokens$text_processed <- gsub(
    snomed_cleaning_patterns[i, 1],
    snomed_cleaning_patterns[i, 2],
    snomed_descriptions_tokens$text_processed,
    perl = TRUE
  )
}

```

The range of tokens is examined to identify **stop words**, that is, common words that can be eliminated, for instance prepositions. Stop words must be eliminated because they are not essential or characteristic components of a clinical term and thus make it more difficult to effectively map terminology. We also eliminate the words `"caused"` and `"due"`.


```{r tokenise_snomed_descriptions}
snomed_descriptions_tokens <- transmute(
  snomed_descriptions_tokens,
  conceptId = conceptId,
  token_raw = stringr::str_split(text_processed, pattern = " ")
) %>%
  unnest(cols = "token_raw") %>% 
  filter(!token_raw %in% stopwords::stopwords(language = "en")) %>% 
  filter(!token_raw %in% c("", " ", ".", "_", "+", "caused", "due")) %>% 
  unique()

snomed_descriptions_tokens %>% 
  group_by(token_raw) %>% 
  summarise(n = n()) %>% 
  arrange(-n) %>% 
  head(30)
```


The data frame is then condensed to have one row per `descriptionId` once again. It is now ready to be used.

```{r condense_snomed_descriptions}
snomed_descriptions_tokens <- snomed_descriptions_tokens %>%
  group_by(conceptId) %>%
  summarise(text_processed = paste(token_raw, collapse = " "))

str(snomed_descriptions_tokens)
```


## Processing antibiotic prescription indication strings


The `drug_indications` dataset contains free text that was manually inputted by clinicians. Due to this, it requires more extensive cleaning than SNOMED CT concept descriptions. A new variable `indication_string` is generated for conversion to lowercase, punctuation cleaning and removal of add hoc concepts. This is particularly the case with information that does not map to SNOMED CT concepts, which must be extracted manually. In this case, prescriptions issued according to advice provided by a microbiologist are often marked with short formulae such as `"as per micro"` or `"d/w micro"` (discussed with microbiology).


```{r clean_drug_indications}
drug_indications$text_processed <- tolower(drug_indications$indication)

indication_cleaning_patterns <- matrix(c(
    "(as per )(dr [a-z]*|micro advice|micro spr on call|sensitivities|micro consultant|micro)", "",
    "d/w micro", "",
    "(\\w)([']s)",                            "\\1",
    "[?();./,]",                              " ",
    "[[:blank:]]{2,}",                        " ",
    "\\buti\\b|\\buit\\b",                    "urinary tract infection",
    "\\babdo\\b",                             "abdominal",
    "pnuemonia|pneumoniae|pnemonia",          "pneumonia",
    "post procedure",                         "post_procedure",
    "postprocedure",                         "post_procedure",
    "urosepsis",                              "sepsis due to urinary tract infection",
    "\\bae\\b",                               "acute exacerbation",
    "\\babx\\b",                               "antibiotic",
    "\\sepssis\\b",                           "sepsis",
    "antipfungal|anti-fungal",                "antifungal",
    "abscesses",                              "abscess",
    "appendectomy-|appendicetomy|appendicectomy", "appendectomy",
    "appendiciits",                           "appendicitis",
    "aquired",                                "acquired",
    "hospital acquired",                      "hospital_acquired",
    "community acquired",                     "community_acquired",
    "celluitis|cellultis",                    "cellulitis",
    "collitis",                               "colitis",
    "\\bseporrhoeic\\b",                      "seborrhoeic",
    "\\bgram neg(ative)?\\b",                 "gram_negative",
    "\\bgram pos(itive)?\\b",                 "gram_positive",
    "\\bg ?-ive\\b",                          "gram_negative",
    "\\bg ?+ive\\b",                          "gram_positive",
    "broncheictasis",                         "bronchiectasis",
    # "e coli|e-coli",                          "B_ESCHR_COLI",
    # "s aurea",                                "F_SCPLR_AURE",
    # "c[.[:blank:]]?diff(icile)?|\\bcdi\\b",   "B_CRDDS_DFFC",
    # "\\bcdi\\b",                              "B_CRDDS_DFFC",
    "xcopd",                                  "exacerbation copd",
    # "staph aureus",                           "B_STPHY_AURS",
    # "staph a\\b",                             "B_STPHY_AURS",
    "\\binfn\\b",                             "infection",
    "tonsilitis|tonsilllitis|tonsilllits",    "tonsillitis",
    "pyelonephr\\b",                          "pyelonephritis",
    "unnknown",                               "unknown",
    "crcl",                                   "creatinine clearance",
    "other please type here",                 "",
    "popst operative|post procedure|postop|post op|psot op", "post operative",
    "\\bcap\\b",                              "community_acquired pneumonia",
    "\\bhap\\b",                              "hospital_acquired pneumonia",
    # "\\bgbs\\b|group b streptococcus|group b strep", "B_STRPT_GRPB",
    "pseudomomonas",                          "pseudomonas",
    "encocarditis",                           "endocarditis",
    "\\bcf\\b",                               "cystic fibrosis",
    "\\bpid\\b",                              "pelvic inflammatory disease",
    "dearrhoea",                              "diarrhea",
    "\\bnpenia\\b|\\bneut\\b|neutropenic|neutroepnic|nuetropenic", "neutropenic",
    "\\bgnr\\b",                              "gram_negative rods",
    "\\bhsv2?\\b",                            "herpes simplex virus",
    "\\bvzv\\b",                              "varicella zoster virus",
    # "e faecalis",                             "B_ENTRC_FCLS",
    "iecpod",                                 "infective exacerbation copd",
    "ipf",                                    "idiopathic pulmonary fibrosis",
    "intra[[:blank:]-]?abdominal|intrabdominal",      "abdominal",
    "infectino|infection:|infeectio",         "infection",
    "inflcted",                               "infected",
    "inplant",                                "implant",
    "\\biud\\b",                              "intrauterine device",
    "\\blrti\\b",                             "lower respiratory tract infection",
    "cadidiasis",                             "candidiasis",
    "calitis",                                "colitis",
    "peri-chondritis",                        "perichondritis",
    "non[-[:blank:]]neutropenic",             "",
    "rectovesico",                            "rectovesical",
    "recieved",                               "received",
    "cultrure|cultures",                      "culture",
    "abration",                               "abrasion",
    "folliculitiis",                          "folliculitis",
    "msu",                                    "mid stream urine",
    "\\bsbp\\b",                              "spontaneous bacterial peritonitis",
    "\\bproph\\b",                            "prophylaxis",
    "supraglottits",                          "supraglottitis"
    #,
    # "mssa",                                   "methicillin sensitive B_STPHY_AURS infection"
  ), ncol=2, byrow = TRUE)
colnames(indication_cleaning_patterns) <- c(
  "pattern",
  "replacement"
)

for(i in seq_len(nrow(indication_cleaning_patterns))) {
  drug_indications$text_processed <- gsub(
    indication_cleaning_patterns[i, 1],
    indication_cleaning_patterns[i, 2],
    drug_indications$text_processed,
    perl = TRUE
  )
}
# 
# system.time({
#   for(i in seq_len(nrow(pathogen_names))) {
#     indications$text_processed <- gsub(
#       paste0("\\b", pathogen_names$token[i], "\\b"),
#       pathogen_names$mo[i],
#       indications$text_processed,
#       perl = TRUE
#     )
#   }
# })
# system.time({
#   for(i in seq_len(nrow(pathogen_geni))) {
#     indications$text_processed <- gsub(
#       paste0("\\b", pathogen_geni$token[i], "\\b"),
#       pathogen_geni$mo[i],
#       indications$text_processed,
#       perl = TRUE
#     )
#   }
# })

drug_indications_tokens <- transmute(
  drug_indications,
  indication = indication,
  text_id = 1:n(),
  token_raw = stringr::str_split(text_processed, pattern = " ")
) %>% 
  unnest(cols = token_raw) %>% 
  filter(!token_raw %in% stopwords::stopwords(language = "en")) %>% 
  filter(!token_raw %in% c("", " ", ".", "_", "+")) %>% 
  unique()

drug_indications_tokens %>% 
  group_by(token_raw) %>% 
  summarise(n = n()) %>% 
  arrange(-n) %>% 
  head(30)


```

```{r condense_drug_indications}
drug_indications_tokens <- drug_indications_tokens %>%
  group_by(text_id) %>%
  summarise(text_processed = paste(token_raw, collapse = " "))

str(drug_indications_tokens)
```

## Mapping SNOMED CT concepts

We use consi

```{r}

it1 = itoken(snomed_descriptions_tokens$text_processed, progressbar = FALSE)
it2 = itoken(drug_indications_tokens$text_processed, progressbar = FALSE)
v = create_vocabulary(it1)
# v = prune_vocabulary(v, doc_proportion_max = 0.1, term_count_min = 5)
vectorizer = vocab_vectorizer(v)

dtm1 = create_dtm(it1, vectorizer)
rownames(dtm1) <- snomed_descriptions_tokens$conceptId
dtm2 = create_dtm(it2, vectorizer)
rownames(dtm2) <- drug_indications_tokens$text_id
```


Blah

```{r echo=TRUE}
d1_d2_cos_sim = sim2(dtm1, dtm2, method = "cosine", norm = "l2")
# consinlink <- reshape2::melt(as.matrix(d1_d2_cos_sim))
# colnames(consinlink) <- c("conceptId", "text_id", "similarity")

consinlink <- d1_d2_cos_sim %>%
  as.matrix %>% 
  data.frame() %>% 
  mutate(conceptId = row.names(.)) %>% 
  pivot_longer(tidyselect::starts_with("X"), 
               names_to = "text_id",
               names_prefix = "X",
               values_to = "similarity")  
consinlink <- consinlink %>% 
  mutate(text_id = as.integer(text_id)) %>% 
  left_join(drug_indications_tokens, by = "text_id") %>% 
  left_join(select(snomed_concepts, conceptId, pt.term), by = "conceptId")

consinlink <- arrange(consinlink, text_id, -similarity) %>% 
  group_by(text_id) %>% 
  mutate(top = row_number()) %>% 
  ungroup()

consinlink %>% 
  filter(similarity > .5 | top == 1) 


```


```{css, echo=FALSE }

body {
   # font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
  line-height: 1.4em;
  font-size: 16px
}

#   
# .note {
#   padding: 1em 1em 1em 4em;
#   margin-bottom: 10px;
#   background: #f5f5f5 5px center/3em no-repeat;
# }

.bd-callout {
  padding: 1.5em;
  margin-top: 2em;
  margin-bottom: 2em;
  border: 1px solid #eee;
  border-left-width: .25rem;
  border-radius: .25rem;
}

.bd-callout h4, h3 {
  padding-top: 0;
  margin-top: 0;
  margin-bottom: .25rem;
}
 
.bd-callout p:last-child {
  margin-bottom: 0;
}

.bd-callout code {
  border-radius: .25rem;
}

.bd-callout + .bd-callout {
  margin-top: -.25rem;
}

.bd-callout-info {
  border-left-color: #5bc0de;
}

# .bd-callout-info h4 {
#   color: #5bc0de;
# }

.bd-callout-warning {
  border-left-color: #f0ad4e;
}

# .bd-callout-warning h4 {
#   color: #f0ad4e;
# }

.bd-callout-danger {
  border-left-color: #d9534f;
}

# .bd-callout-danger h4 {
#   color: #d9534f;
# }

.bd-examples .img-thumbnail {
  margin-bottom: .75rem;
}

.bd-examples h4 {
  margin-bottom: .25rem;
}

.bd-examples p {
  margin-bottom: 1.25rem;
}
```
